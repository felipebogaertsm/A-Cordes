name: Ã  cordes CI/CD Pipeline

on:
  push:
    branches:
      - master
  pull_request:
    branches: 
      - master

env:
  BACKEND_IMAGE_NAME: a_cordes_backend
  FRONTEND_IMAGE_NAME: a_cordes_frontend
  TAG: ${{ github.sha }}
  DOCKER_USER: ${{ secrets.DOCKER_USER }}
  DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
  KUBECONFIG: ${{ secrets.KUBECONFIG }}

jobs:
  build-backend:
    name: Build backend
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Backend build and push
      run: |
        cd a_cordes
        docker login -u "${{ env.DOCKER_USER }}" -p "${{ env.DOCKER_PASSWORD }}"
        docker build --pull -t "${{ env.DOCKER_USER }}/${{ env.BACKEND_IMAGE_NAME }}:${{ env.TAG }}" .
        docker push ${{ env.DOCKER_USER }}/${{ env.BACKEND_IMAGE_NAME }}:${{ env.TAG }}

  build-frontend:
    name: Build frontend
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Frontend build and push
      run: |
        cd frontend
        docker login -u "${{ env.DOCKER_USER }}" -p "${{ env.DOCKER_PASSWORD }}"
        docker build --pull -t "${{ env.DOCKER_USER }}/${{ env.FRONTEND_IMAGE_NAME }}:${{ env.TAG }}" .
        docker push ${{ env.DOCKER_USER }}/${{ env.FRONTEND_IMAGE_NAME }}:${{ env.TAG }}

  test:
    name: Testing the backend
    runs-on: ubuntu-latest
    needs: 
    - build-backend
    container: 
      image: felipebogaertsm/a_cordes_backend:${TAG}
      options: --user root
    steps:
    - uses: actions/checkout@v3
    - name: Testing
      run: |
        cd a_cordes
        pip3 freeze
        python3 -m pytest
  
  deploy-backend:
    name: Deploy backend
    runs-on: ubuntu-latest
    needs:
      - test
      - build-backend
    container: bitnami/kubectl:latest
    env:
      NAMESPACE: a-cordes
      IMAGE_NAME: a_cordes_backend
      DEPLOYMENT_NAME: a-cordes-backend
      CONTAINER_NAME: a-cordes-backend
    steps:
    - uses: actions/checkout@v3
    - uses: azure/k8s-set-context@v2
      with:
        method: kubeconfig
        kubeconfig: ${{ env.KUBECONFIG }}
    - name: Deployment
      run: |
        kubectl -n ${NAMESPACE} set image deployment/${DEPLOYMENT_NAME} ${CONTAINER_NAME}="${{ env.DOCKER_USER }}/${IMAGE_NAME}:${{ env.TAG }}"
        
  deploy-frontend: 
    name: Deploy frontend
    runs-on: ubuntu-latest
    needs: 
      - test
      - build-frontend
    container: bitnami/kubectl:latest
    env:
      NAMESPACE: a-cordes
      IMAGE_NAME: a_cordes_frontend
      DEPLOYMENT_NAME: a-cordes-frontend
      CONTAINER_NAME: a-cordes-frontend
    steps:
    - uses: actions/checkout@v3
    - uses: azure/k8s-set-context@v2
      with:
        method: kubeconfig
        kubeconfig: ${{ env.KUBECONFIG }}
    - name: Deployment
      run: |
        kubectl -n ${NAMESPACE} set image deployment/${DEPLOYMENT_NAME} ${CONTAINER_NAME}="${{ env.DOCKER_USER }}/${IMAGE_NAME}:${{ env.TAG }}"
        